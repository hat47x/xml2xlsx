# ADR 003: 設定ファイルの構造変更とデータ参照方式

## ステータス
実装済み 2025-01-26
- トップレベルセクションを`mapping`に変更完了
- 親子関係の項目継承ルールを実装完了
- columnsセクションでの一元管理を実装完了
- すべてのテストケースが成功
- 既存機能への影響なし（全47個のテストが成功）

## Context
XMLからExcelへの変換において、親子関係のあるデータ構造を処理する際に、以下の課題が発生していた：
- 親エンティティの項目を子エンティティから参照する方法が不明確
- 同じ名前の項目が親子で存在する場合の扱いが不明確
- 設定ファイルの構造が直感的でない

## Decision
以下の変更を実施する：

1. 設定ファイルのトップレベルセクションを`entities`から`mapping`に変更
- より目的を明確に表現
- データマッピングという本質的な機能を強調

2. 親子関係の項目継承ルール
- 名前が重複する場合：`親エンティティ名.項目名`形式で参照
- 重複しない場合：そのままの項目名を使用

3. columnsセクションでの一元管理
- `column_order`と`column_names`を統合
- 定義順でカラム順序を管理
- 日本語名を直接マッピング

## 代替案
### 案1: $parent記法の導入
```toml
"$parent.id" = "所属会社ID"
```
- メリット：親子関係が明示的
- デメリット：
  - 新しい記法の導入が必要
  - パーサーの複雑化
  - 直感的でない可能性

### 案2: 参照パスの使用
```toml
"../id" = "所属会社ID"
```
- メリット：ファイルシステムのような馴染みのある記法
- デメリット：
  - XMLの構造と一致しない場合がある
  - 深い階層での可読性低下

## Consequences
### ポジティブ
- 設定ファイルの可読性向上
- 親子関係の表現が明確化
- メンテナンス性の向上

### ネガティブ
- 既存の設定ファイルの修正が必要
- 後方互換性の維持が必要

## Notes
- 既存の設定ファイルは段階的に移行
- 古い形式もしばらくサポート
- ドキュメントの更新も並行して実施

## 移行計画
1. 新規プロジェクトでは新しい構造を使用
2. 既存プロジェクトは優先度に応じて順次移行
3. 2025年Q2末までに完全移行を目指す